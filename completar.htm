<!DOCTYPE HTML>
<html>
<head>
<meta charset="UTF-8">
<title>Completar arrastrando</title>
<script type="text/javascript">

var oDragTargets = [];
var oDragTarget = null;
var oDragItem = null;
var iClickOffsetX = 0;
var iClickOffsetY = 0;

var buenas = 0;
var contestadas = 0;
var total = 4;

function OnLoad(){
	SetupDragDrop();
}

function SetupDragDrop(){
	oDragTargets = [];
	
	var oList = document.getElementsByTagName("div");
	for(var i=0; i<oList.length; i++){
		var o = oList[i];
		if (o.className == "DropTarget"){
			oDragTargets[oDragTargets.length] = GetObjPos(o);
		}else if (o.className == "Dragable"){
			MakeDragable(o);
			o.padreOriginal = o.parentNode;
			o.intentos = 0;
			mensajear(o.parentNode + " - " + o.padreOriginal);
		}
	}
}

function MakeDragable(oBox){
	//if (navigator.platform=="iPad" || navigator.platform =="iPhone"){
	if (is_touch_device()){
		oBox.ontouchstart= function(e){TouchStart(e)};
		oBox.ontouchmove=function(e){TouchMove(e)};
		oBox.ontouchend=function(e){TouchEnd(e)};
	}else{
		oBox.onmousemove= function(e){DragMove(oBox,e)};
		oBox.onmouseup=function(e){DragStop(oBox,e)};
		oBox.onmousedown=function(e){DragStart(oBox,e);return false};
	}
}
//Extra para deshabilitar
function UnmakeDragable(oBox){
	if (is_touch_device()){
		oBox.ontouchstart = null;
		oBox.ontouchmove = null
		oBox.ontouchend = null;
	}else{
		oBox.onmousemove = null;
		oBox.onmouseup = null;
		oBox.onmousedown = null;
	}
	oBox.style.cursor = "auto";
}

function is_touch_device() {
  return 'ontouchstart' in window; // works on most browsers 
      //|| 'onmsgesturechange' in window; // funciona en ie10, no en 11
};


function TouchStart(e){
	var oPos = GetObjPos(e.target);
	iClickOffsetX = e.targetTouches[0].pageX - oPos.x;
	iClickOffsetY = e.targetTouches[0].pageY - oPos.y;
}

function DragStart(o,e){
	if(!e) var e = window.event;
	oDragItem = o;
	
	if (e.offsetX){
		iClickOffsetX = e.offsetX;
		iClickOffsetY = e.offsetY;	
	}else{
		var oPos = GetObjPos(o);
		iClickOffsetX = e.clientX - oPos.x;
		iClickOffsetY = e.clientY - oPos.y;
	}
	
	if (o.setCapture){
		o.setCapture();
	}else{
		window.addEventListener ("mousemove", DragMove2, true);
		window.addEventListener ("mouseup",   DragStop2, true);
	}
}

function DragMove2(e){
	DragMove(oDragItem,e);
}

function DragStop2(e){
	DragStop(oDragItem,e);
}

function DragMove(o,e){
	if (oDragItem==null) return;

	if(!e) var e = window.event;
	var x = e.clientX + document.body.scrollLeft - document.body.clientLeft - iClickOffsetX;
	var y = e.clientY + document.body.scrollTop  - document.body.clientTop - iClickOffsetY;
	
	HandleDragMove(x,y);
}

function HandleDragMove(x,y){
	with(oDragItem.style){
		zIndex = 1000;
		position="absolute";
		left=x+"px";
		top=y+"px";
	}
	
	for (var i=0; i< oDragTargets.length; i++){
		var oTarget = oDragTargets[i];
		if (oTarget.x < x && oTarget.y < y && (oTarget.x + oTarget.w) > x && (oTarget.y + oTarget.h) > y){
			if (oDragTarget!=null && oDragTarget != oTarget.o) OnTargetOut();
			oDragTarget = oTarget.o;
			OnTargetOver();
			return;
		}
	}
	
	if (oDragTarget){
		OnTargetOut();
		oDragTarget = null;
	}
}

function TouchMove(e){
    e.preventDefault();
    var x = e.targetTouches[0].pageX - iClickOffsetX;
    var y = e.targetTouches[0].pageY - iClickOffsetY;
    oDragItem = e.targetTouches[0].target;
    HandleDragMove(x,y);
}

function DragStop(o,e){
	if (o.releaseCapture){
		o.releaseCapture();
	}else if (oDragItem){
		window.removeEventListener ("mousemove", DragMove2, true);
		window.removeEventListener ("mouseup",   DragStop2, true);
	}
	
	HandleDragStop();
}

function HandleDragStop(){
	if (oDragItem==null) {
		return;
	}
	if (oDragTarget){
		mensajear("oDragTarget true: "+ oDragItem.getAttribute("data-tipo") + " - " + oDragTarget.getAttribute("data-destino"));
		if(oDragItem.getAttribute("data-tipo") == oDragTarget.getAttribute("data-destino")){
			oDragTarget.getElementsByClassName('palomita').item(0).style.display = "";
			mensajear("padre: "+ oDragTarget.getElementsByClassName('palomita').item(0));
			OnTargetOut();
			OnTargetDrop();
			oDragTarget = null;
			contestadas++;
			buenas++;
			revisar();
		} else {
			oDragItem.padreOriginal.appendChild(oDragItem);
			oDragItem.style.position="";
			oDragItem.intentos++;
			mensajear("intentos: "+oDragItem.intentos);
			if(oDragItem.intentos >= 2){
				UnmakeDragable(oDragItem);
				oDragItem.getElementsByClassName('tache').item(0).style.display = "";
				mensajear("intentos sobrepasados: ");
				contestadas++;
				revisar();
			}
		}
	} else {
		//Agregado para que regrese si no se coloca en una caja
		mensajear("oDragTarget es falso, padre"+oDragItem.parentNode + " - original: " + oDragItem.padreOriginal);
		oDragItem.padreOriginal.appendChild(oDragItem);
		oDragItem.style.position="";
	}
	
	oDragItem.style.zIndex = 1;
	oDragItem = null;
}
function revisar(){
	if(contestadas == total){
		mensajear("Terminó todo");
		retroalimentar('Obtuviste '+ buenas + " de " + total +'.<br /><input type="button" value="Otra vez" onClick="window.location.reload()">');
	}
}

function TouchEnd(e){
	//e.target.innerHTML = "TouchEnd";
	HandleDragStop();
}

function $(s){
	return document.getElementById(s);
}

function GetObjPos(obj){
	var x = 0;
	var y = 0;
	var o = obj;
	
	var w = obj.offsetWidth;
	var h = obj.offsetHeight;
	if (obj.offsetParent) {
		x = obj.offsetLeft
		y = obj.offsetTop
		while (obj = obj.offsetParent){
			x += obj.offsetLeft;
			y += obj.offsetTop;
		}
	}
	return {x:x, y:y, w:w, h:h, o:o};
}

//Drag and Drop Events
function OnTargetOver(){
	oDragTarget.style.border = "3px solid red";
}

function OnTargetOut(){
	oDragTarget.style.border = "";
}

function OnTargetDrop(){
	oDragItem.style.position="";
	oDragTarget.appendChild(oDragItem);
	//if (navigator.platform=="iPad") MakeDragable(oDragItem);
	if (is_touch_device()) MakeDragable(oDragItem);
}

function mensajear(cadena){
	//document.getElementById("mensajes").innerHTML = cadena;
}
function retroalimentar(texto){
	document.getElementById("retroalimentacion").innerHTML = texto;
}
</script>
<style>
body{
	font-family:"Helvetica", Arial, sans-serif;
	font-size:0.9em;
}
.parrafo{
	line-height: 2.5em;
}
.Dragable{
	cursor: move;
	-moz-user-select: -moz-none;
	-khtml-user-select: none;
	-webkit-user-select: none;
	-o-user-select: none;
	user-select: none;
	width: auto;
	/*height: 2em;*/
	margin: 0px;
	padding: 3px;
	display: inline-block;
	color: #000;
	font-weight: bold;
	border: 1px solid black;
	background-color:#FFF;
	vertical-align:middle;
}

.DropTarget{
	min-width: 10em; 
	min-height: 2.5em; 
	background-color: #CEF;
	border: 1px solid gray;
	overflow:visible;
	display:inline-block;
	vertical-align:middle;
}
.DropTarget .Dragable{
	height:auto;
	background:none;
	overflow:visible;
	border:none;
	display:inline-block;
	vertical-align:middle;	
}
body{
	text-align:center;
}

</style>
</head>
<body onLoad="OnLoad()">
<h1>Completar arrastrando</h1>

<div class="parrafo">

1.- Negroponte opina que: "Los niños leen y escriben en Internet para <div class="DropTarget" data-destino="comunicarse"><img class="palomita" style="display:none" src="palomita.png" /></div> y no sólo para completar algún ejercicio abstracto y artificial".<br />

2.- A la Internet la podemos comparar como a una gran <div class="DropTarget" data-destino="biblioteca"><img class="palomita" style="display:none" src="palomita.png" /></div>.<br />

3.-El <div class="DropTarget" data-destino="INEGI"><img class="palomita" style="display:none" src="palomita.png" /></div> es la entidad del Gobierno mexicano que desarrollo el Portal Ciberhabitat.<br />

4.- El proyecto <div class="DropTarget" data-destino="Enciclomedia"><img class="palomita" style="display:none" src="palomita.png" /></div> es un programa de cómputo multimedia que relaciona los contenidos digitales de los libros de texto con recursos interactivos a través de ligas de hipertexto.

</div>

<p>
<div class="Dragable" data-tipo="comunicarse"><img class="tache" style="display:none" src="tache.png" />comunicarse</div>
<div class="Dragable" data-tipo="biblioteca"><img class="tache" style="display:none" src="tache.png" />biblioteca</div>
<div class="Dragable" data-tipo="INEGI"><img class="tache" style="display:none" src="tache.png" />INEGI</div>
<div class="Dragable" data-tipo="Enciclomedia"><img class="tache" style="display:none" src="tache.png" />Enciclomedia</div>
</p>


<script>
//document.write("<p>Plataforma: "+navigator.platform+"</p>");
</script>
<div id="retroalimentacion"></div>
<div id="mensajes"></div>
</body>
</html>